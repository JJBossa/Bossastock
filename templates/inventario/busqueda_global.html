{% extends 'base.html' %}
{% load static %}

{% block title %}Búsqueda Global - STOCKEX{% endblock %}

{% block extra_css %}
<style>
    .resultado-item {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
    }
    .resultado-item:hover {
        border-left-color: #0d6efd;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .tipo-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .historial-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .historial-item:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'inicio' %}"><i class="bi bi-house-door"></i> Inicio</a></li>
        <li class="breadcrumb-item active">Búsqueda Global</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-search text-primary"></i> Búsqueda Global</h2>
    <div class="d-flex gap-2">
        <a href="{% url 'inicio' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Inicio
        </a>
        <a href="{% url 'historial_busquedas' %}" class="btn btn-outline-secondary">
            <i class="bi bi-clock-history"></i> Ver Historial
        </a>
    </div>
</div>

<!-- Barra de Búsqueda -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" action="{% url 'busqueda_global' %}">
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="q" class="form-label">Buscar:</label>
                    <input type="text" 
                           class="form-control form-control-lg" 
                           id="q" 
                           name="q" 
                           value="{{ query }}"
                           placeholder="Buscar productos, clientes, ventas, cotizaciones..."
                           autofocus>
                </div>
                <div class="col-md-4">
                    <label for="tipo" class="form-label">Tipo:</label>
                    <select class="form-select form-select-lg" id="tipo" name="tipo">
                        <option value="todos" {% if tipo == 'todos' %}selected{% endif %}>Todos</option>
                        <option value="productos" {% if tipo == 'productos' %}selected{% endif %}>Productos</option>
                        <option value="clientes" {% if tipo == 'clientes' %}selected{% endif %}>Clientes</option>
                        <option value="ventas" {% if tipo == 'ventas' %}selected{% endif %}>Ventas</option>
                        <option value="cotizaciones" {% if tipo == 'cotizaciones' %}selected{% endif %}>Cotizaciones</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-search"></i> Buscar
                </button>
                <small class="text-muted ms-3">
                    <i class="bi bi-keyboard"></i> Presiona <kbd>Ctrl</kbd> + <kbd>K</kbd> para búsqueda rápida
                </small>
            </div>
        </form>
    </div>
</div>

<!-- Resultados -->
{% if query %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-list-ul"></i> Resultados 
            <span class="badge bg-light text-dark">{{ resultados.total }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% if resultados.total == 0 %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No se encontraron resultados para "{{ query }}"
        </div>
        {% else %}
        <!-- Productos -->
        {% if resultados.productos %}
        <div class="mb-4">
            <h6 class="text-primary">
                <i class="bi bi-box-seam"></i> Productos ({{ resultados.productos|length }})
            </h6>
            {% for item in resultados.productos %}
            <div class="resultado-item card mb-2">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <a href="{{ item.url }}" class="text-decoration-none">{{ item.nombre }}</a>
                                <span class="badge tipo-badge bg-primary">{{ item.tipo|title }}</span>
                            </h6>
                            <p class="mb-1 text-muted small">
                                {% if item.sku %}<strong>SKU:</strong> {{ item.sku }} | {% endif %}
                                <strong>Precio:</strong> ${{ item.precio|floatformat:0 }} | 
                                <strong>Stock:</strong> {{ item.stock }} | 
                                {% if item.categoria %}<strong>Categoría:</strong> {{ item.categoria }}{% endif %}
                            </p>
                        </div>
                        <a href="{{ item.url }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-right"></i> Ver
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Clientes -->
        {% if resultados.clientes %}
        <div class="mb-4">
            <h6 class="text-success">
                <i class="bi bi-person"></i> Clientes ({{ resultados.clientes|length }})
            </h6>
            {% for item in resultados.clientes %}
            <div class="resultado-item card mb-2">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <a href="{{ item.url }}" class="text-decoration-none">{{ item.nombre }}</a>
                                <span class="badge tipo-badge bg-success">{{ item.tipo|title }}</span>
                            </h6>
                            <p class="mb-1 text-muted small">
                                {% if item.rut %}<strong>RUT:</strong> {{ item.rut }} | {% endif %}
                                {% if item.email %}<strong>Email:</strong> {{ item.email }} | {% endif %}
                                {% if item.telefono %}<strong>Teléfono:</strong> {{ item.telefono }}{% endif %}
                            </p>
                        </div>
                        <a href="{{ item.url }}" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-arrow-right"></i> Ver
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Ventas -->
        {% if resultados.ventas %}
        <div class="mb-4">
            <h6 class="text-info">
                <i class="bi bi-receipt"></i> Ventas ({{ resultados.ventas|length }})
            </h6>
            {% for item in resultados.ventas %}
            <div class="resultado-item card mb-2">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <a href="{{ item.url }}" class="text-decoration-none">{{ item.numero_venta }}</a>
                                <span class="badge tipo-badge bg-info">{{ item.tipo|title }}</span>
                            </h6>
                            <p class="mb-1 text-muted small">
                                <strong>Cliente:</strong> {{ item.cliente }} | 
                                <strong>Total:</strong> ${{ item.total|floatformat:0 }} | 
                                <strong>Fecha:</strong> {{ item.fecha }}
                            </p>
                        </div>
                        <a href="{{ item.url }}" class="btn btn-sm btn-outline-info">
                            <i class="bi bi-arrow-right"></i> Ver
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Cotizaciones -->
        {% if resultados.cotizaciones %}
        <div class="mb-4">
            <h6 class="text-warning">
                <i class="bi bi-file-earmark-text"></i> Cotizaciones ({{ resultados.cotizaciones|length }})
            </h6>
            {% for item in resultados.cotizaciones %}
            <div class="resultado-item card mb-2">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <a href="{{ item.url }}" class="text-decoration-none">{{ item.numero_cotizacion }}</a>
                                <span class="badge tipo-badge bg-warning text-dark">{{ item.tipo|title }}</span>
                            </h6>
                            <p class="mb-1 text-muted small">
                                <strong>Cliente:</strong> {{ item.cliente }} | 
                                <strong>Total:</strong> ${{ item.total|floatformat:0 }} | 
                                <strong>Fecha:</strong> {{ item.fecha }}
                            </p>
                        </div>
                        <a href="{{ item.url }}" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-arrow-right"></i> Ver
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Historial Reciente -->
{% if historial_reciente %}
<div class="card">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-clock-history"></i> Búsquedas Recientes</h6>
    </div>
    <div class="card-body">
        <div class="list-group list-group-flush">
            {% for busqueda in historial_reciente %}
            <a href="{% url 'busqueda_global' %}?q={{ busqueda.query }}" class="list-group-item list-group-item-action historial-item">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>{{ busqueda.query }}</strong>
                        <small class="text-muted d-block">{{ busqueda.fecha|date:"d/m/Y H:i" }}</small>
                    </div>
                    <span class="badge bg-secondary">{{ busqueda.resultados }} resultados</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/busqueda-global.js' %}"></script>
{% endblock %}

