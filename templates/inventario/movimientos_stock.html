{% extends 'base.html' %}

{% block title %}Movimientos de Stock - STOCKEX{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'inicio' %}"><i class="bi bi-house-door"></i> Inicio</a></li>
        <li class="breadcrumb-item active">Movimientos de Stock</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-arrow-left-right text-primary"></i> Movimientos de Stock</h2>
    <a href="{% url 'inicio' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver al Inicio
    </a>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Producto</label>
                <select name="producto" class="form-select">
                    <option value="">Todos los productos</option>
                    {% for producto in productos %}
                    <option value="{{ producto.id }}" {% if producto_id == producto.id|stringformat:"s" %}selected{% endif %}>
                        {{ producto.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Tipo</label>
                <select name="tipo" class="form-select">
                    <option value="">Todos</option>
                    <option value="entrada" {% if tipo == 'entrada' %}selected{% endif %}>Entrada</option>
                    <option value="salida" {% if tipo == 'salida' %}selected{% endif %}>Salida</option>
                    <option value="ajuste" {% if tipo == 'ajuste' %}selected{% endif %}>Ajuste</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Desde</label>
                <input type="date" name="fecha_desde" class="form-control" value="{{ fecha_desde }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Hasta</label>
                <input type="date" name="fecha_hasta" class="form-control" value="{{ fecha_hasta }}">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search"></i> Filtrar
                </button>
                <a href="{% url 'listar_movimientos' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Limpiar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5><i class="bi bi-arrow-down-circle"></i> Total Entradas</h5>
                <h3>{{ total_entradas }} unidades</h3>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h5><i class="bi bi-arrow-up-circle"></i> Total Salidas</h5>
                <h3>{{ total_salidas }} unidades</h3>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de movimientos -->
<div class="card">
    <div class="card-body">
        {% if movimientos %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Producto</th>
                        <th>Tipo</th>
                        <th>Cantidad</th>
                        <th>Motivo</th>
                        <th>Stock Anterior</th>
                        <th>Stock Nuevo</th>
                        <th>Usuario</th>
                    </tr>
                </thead>
                <tbody>
                    {% for movimiento in movimientos %}
                    <tr>
                        <td>{{ movimiento.fecha|date:"d/m/Y H:i" }}</td>
                        <td><strong>{{ movimiento.producto.nombre }}</strong></td>
                        <td>
                            {% if movimiento.tipo == 'entrada' %}
                            <span class="badge bg-success">{{ movimiento.get_tipo_display }}</span>
                            {% elif movimiento.tipo == 'salida' %}
                            <span class="badge bg-danger">{{ movimiento.get_tipo_display }}</span>
                            {% else %}
                            <span class="badge bg-warning">{{ movimiento.get_tipo_display }}</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ movimiento.cantidad }}</strong></td>
                        <td>{{ movimiento.get_motivo_display }}</td>
                        <td>{{ movimiento.stock_anterior }}</td>
                        <td><strong>{{ movimiento.stock_nuevo }}</strong></td>
                        <td>{{ movimiento.usuario.username|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginación -->
        {% if movimientos.has_other_pages %}
        <nav aria-label="Paginación">
            <ul class="pagination justify-content-center">
                {% if movimientos.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ movimientos.previous_page_number }}">Anterior</a>
                </li>
                {% endif %}
                <li class="page-item active">
                    <span class="page-link">Página {{ movimientos.number }} de {{ movimientos.paginator.num_pages }}</span>
                </li>
                {% if movimientos.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ movimientos.next_page_number }}">Siguiente</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
            <h4 class="mt-3">No hay movimientos registrados</h4>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block ayuda %}
{% include 'inventario/ayuda_contextual.html' %}
{% endblock %}

